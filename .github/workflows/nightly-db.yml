name: nightly-db-harness

on:
  schedule:
    - cron: '30 1 * * *' # 01:30 UTC daily
  workflow_dispatch:

jobs:
  db-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ secrets.SUPABASE_URL && secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build (node)
        run: npm run build

      - name: Run DB harness integration tests
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npm run test:integration:ci

      - name: Upload DB integration reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-db-reports
          path: |
            reports/**/*.xml

      - name: Publish DB test summary
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            reports/integration-junit.xml

      - name: Notify Discord on failure
        if: failure() && secrets.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          payload=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg sha "${{ github.sha }}" \
            --arg ref "${{ github.ref_name }}" \
            '{content: ("❌ Nightly DB harness failed for " + $repo + "\nBranch: " + $ref + "\nSHA: " + $sha + "\nRun: https://github.com/" + $repo + "/actions/runs/" + $run_id)}')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: Create issue after 2 consecutive failures
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const runsResp = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              event: 'schedule',
              status: 'completed',
              per_page: 5,
            });

            const runs = runsResp.data.workflow_runs
              .filter(r => r.name === 'nightly-db-harness')
              .slice(0, 3);

            if (runs.length < 2) {
              core.info('Not enough historical scheduled runs; skip issue creation gate.');
              return;
            }

            const latestTwoFailed = runs[0].conclusion === 'failure' && runs[1].conclusion === 'failure';
            if (!latestTwoFailed) {
              core.info('Failure is not consecutive (2x); skip issue creation.');
              return;
            }

            const title = `Nightly DB harness failed (2x): ${new Date().toISOString().slice(0,10)}`;
            const body = [
              'Nightly DB harness failed in 2 consecutive scheduled runs.',
              '',
              `- Current run: https://github.com/${owner}/${repo}/actions/runs/${context.runId}`,
              `- Previous run: ${runs[1].html_url}`,
              `- SHA: ${context.sha}`,
              `- Ref: ${context.ref}`,
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 100,
            });

            const exists = issues.find(i => i.title === title);
            if (!exists) {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ['nightly-failure', 'ci'],
              });
            }

      - name: Close open nightly failure issues on success
        if: success() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 100,
            });

            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `✅ Nightly DB harness is healthy again. Auto-closing on run ${context.runId}.`,
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
              });
            }
