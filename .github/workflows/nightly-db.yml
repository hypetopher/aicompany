name: nightly-db-harness

on:
  schedule:
    - cron: '30 1 * * *' # 01:30 UTC daily
  workflow_dispatch:

jobs:
  db-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ secrets.SUPABASE_URL && secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build (node)
        run: npm run build

      - name: Run DB harness integration tests
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npm run test:integration:ci

      - name: Upload DB integration reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-db-reports
          path: |
            reports/**/*.xml

      - name: Publish DB test summary
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            reports/integration-junit.xml

      - name: Notify Discord on failure
        if: failure() && secrets.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          payload=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg sha "${{ github.sha }}" \
            --arg ref "${{ github.ref_name }}" \
            '{content: ("❌ Nightly DB harness failed for " + $repo + "\nBranch: " + $ref + "\nSHA: " + $sha + "\nRun: https://github.com/" + $repo + "/actions/runs/" + $run_id)}')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"

      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly DB harness failed: ${new Date().toISOString().slice(0,10)}`;
            const body = [
              'Nightly DB harness workflow failed.',
              '',
              `- Workflow: ${context.workflow}`,
              `- Run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              `- SHA: ${context.sha}`,
              `- Ref: ${context.ref}`,
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 100,
            });

            const exists = issues.find(i => i.title === title);
            if (!exists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['nightly-failure', 'ci'],
              });
            }

      - name: Close open nightly failure issues on success
        if: success() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 100,
            });

            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `✅ Nightly DB harness is healthy again. Auto-closing on run ${context.runId}.`,
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
              });
            }
